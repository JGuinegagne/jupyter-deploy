schema_version: 1
template:
  name: tf-aws-ec2-base
  engine: terraform
  version: 0.3.0
requirements:
- name: terraform
- name: awscli
- name: jq
- name: curl
values:
- name: open_url
  source: output
  source-key: jupyter_url
- name: aws_region
  source: output
  source-key: region
- name: persisting_resources
  source: output
  source-key: persisting_resources
services:
- jupyter
- traefik
- oauth
commands:
- cmd: host.status
  sequence:
  - api-name: aws.ec2.describe-instance-status
    arguments:
    - api-attribute: instance_id
      source: output
      source-key: instance_id
  results:
  - result-name: host.status
    source: result
    source-key: '[0].InstanceStateName'
- cmd: host.stop
  sequence:
  - api-name: aws.ec2.stop-instance
    arguments:
    - api-attribute: instance_id
      source: output
      source-key: instance_id
  - api-name: aws.ec2.wait-for-stopped
    arguments:
    - api-attribute: instance_id
      source: output
      source-key: instance_id
- cmd: host.start
  sequence:
  - api-name: aws.ec2.start-instance
    arguments:
    - api-attribute: instance_id
      source: output
      source-key: instance_id
  - api-name: aws.ec2.wait-for-running
    arguments:
    - api-attribute: instance_id
      source: output
      source-key: instance_id
- cmd: host.restart
  sequence:
  - api-name: aws.ec2.reboot-instance
    arguments:
    - api-attribute: instance_id
      source: output
      source-key: instance_id
  - api-name: aws.ec2.wait-for-running
    arguments:
    - api-attribute: instance_id
      source: output
      source-key: instance_id
- cmd: host.connect
  sequence:
  - api-name: aws.ssm.start-session
    arguments:
    - api-attribute: target_id
      source: output
      source-key: instance_id
- cmd: host.exec
  sequence:
  - api-name: aws.ssm.wait-default-shell-command-sync
    arguments:
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: commands
      source: cli
      source-key: commands
  results:
  - result-name: host.exec.stdout
    source: result
    source-key: '[0].StandardOutputContent'
  - result-name: host.exec.stderr
    source: result
    source-key: '[0].StandardErrorContent'
  - result-name: host.exec.returncode
    source: result
    source-key: '[0].ResponseCode'
- cmd: server.status
  sequence:
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: server_status_check_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
  results:
  - result-name: server.status
    source: result
    source-key: '[0].StandardOutputContent'
- cmd: server.start
  sequence:
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: server_update_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: action
      source: cli
      source-key: action
    - api-attribute: service
      source: cli
      source-key: service
- cmd: server.stop
  sequence:
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: server_update_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: action
      source: cli
      source-key: action
    - api-attribute: service
      source: cli
      source-key: service
- cmd: server.restart
  sequence:
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: server_update_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: action
      source: cli
      source-key: action
    - api-attribute: service
      source: cli
      source-key: service
- cmd: server.logs
  sequence:
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: server_logs_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: service
      source: cli
      source-key: service
    - api-attribute: extra
      source: cli
      source-key: extra
  results:
  - result-name: server.logs
    source: result
    source-key: '[0].StandardOutputContent'
  - result-name: server.errors
    source: result
    source-key: '[0].StandardErrorContent'
- cmd: server.exec
  sequence:
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: server_exec_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: service
      source: cli
      source-key: service
    - api-attribute: commands
      source: cli
      source-key: commands
  results:
  - result-name: server.exec.stdout
    source: result
    source-key: '[0].StandardOutputContent'
  - result-name: server.exec.stderr
    source: result
    source-key: '[0].StandardErrorContent'
  - result-name: server.exec.returncode
    source: result
    source-key: '[0].ResponseCode'
- cmd: server.connect
  sequence:
  - api-name: aws.ssm.start-session
    arguments:
    - api-attribute: target_id
      source: output
      source-key: instance_id
    - api-attribute: document_name
      source: output
      source-key: server_connect_document
    - api-attribute: service
      source: cli
      source-key: service
- cmd: users.add
  sequence:
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: auth_users_update_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: users
      source: cli
      source-key: users
    - api-attribute: action
      source: cli
      source-key: action
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: auth_check_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: category
      source: cli
      source-key: category
  updates:
  - variable-name: oauth_allowed_usernames
    source: result
    source-key: '[1].StandardOutputContent'
    transform: comma-separated-str-to-list-str
- cmd: users.remove
  sequence:
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: auth_users_update_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: users
      source: cli
      source-key: users
    - api-attribute: action
      source: cli
      source-key: action
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: auth_check_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: category
      source: cli
      source-key: category
  updates:
  - variable-name: oauth_allowed_usernames
    source: result
    source-key: '[1].StandardOutputContent'
    transform: comma-separated-str-to-list-str
- cmd: users.set
  sequence:
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: auth_users_update_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: users
      source: cli
      source-key: users
    - api-attribute: action
      source: cli
      source-key: action
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: auth_check_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: category
      source: cli
      source-key: category
  updates:
  - variable-name: oauth_allowed_usernames
    source: result
    source-key: '[1].StandardOutputContent'
    transform: comma-separated-str-to-list-str
- cmd: users.list
  sequence:
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: auth_check_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: category
      source: cli
      source-key: category
  results:
  - result-name: users.list
    source: result
    source-key: '[0].StandardOutputContent'
    transform: comma-separated-str-to-list-str
- cmd: teams.add
  sequence:
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: auth_teams_update_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: teams
      source: cli
      source-key: teams
    - api-attribute: action
      source: cli
      source-key: action
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: auth_check_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: category
      source: cli
      source-key: category
  updates:
  - variable-name: oauth_allowed_teams
    source: result
    source-key: '[1].StandardOutputContent'
    transform: comma-separated-str-to-list-str
- cmd: teams.remove
  sequence:
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: auth_teams_update_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: teams
      source: cli
      source-key: teams
    - api-attribute: action
      source: cli
      source-key: action
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: auth_check_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: category
      source: cli
      source-key: category
  updates:
  - variable-name: oauth_allowed_teams
    source: result
    source-key: '[1].StandardOutputContent'
    transform: comma-separated-str-to-list-str
- cmd: teams.set
  sequence:
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: auth_teams_update_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: teams
      source: cli
      source-key: teams
    - api-attribute: action
      source: cli
      source-key: action
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: auth_check_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: category
      source: cli
      source-key: category
  updates:
  - variable-name: oauth_allowed_teams
    source: result
    source-key: '[1].StandardOutputContent'
    transform: comma-separated-str-to-list-str
- cmd: teams.list
  sequence:
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: auth_check_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: category
      source: cli
      source-key: category
  results:
  - result-name: teams.list
    source: result
    source-key: '[0].StandardOutputContent'
    transform: comma-separated-str-to-list-str
- cmd: organization.set
  sequence:
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: auth_org_set_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: organization
      source: cli
      source-key: organization
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: auth_check_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: category
      source: cli
      source-key: category
  updates:
  - variable-name: oauth_allowed_org
    source: result
    source-key: '[1].StandardOutputContent'
- cmd: organization.unset
  sequence:
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: auth_org_unset_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: auth_check_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: category
      source: cli
      source-key: category
  updates:
  - variable-name: oauth_allowed_org
    source: result
    source-key: '[1].StandardOutputContent'
- cmd: organization.get
  sequence:
  - api-name: aws.ssm.wait-command-sync
    arguments:
    - api-attribute: document_name
      source: output
      source-key: auth_check_document
    - api-attribute: instance_id
      source: output
      source-key: instance_id
    - api-attribute: category
      source: cli
      source-key: category
  results:
  - result-name: organization.get
    source: result
    source-key: '[0].StandardOutputContent'
supervised-execution:
  config:
    config.terraform-plan:
      default-phase:
        label: "Reading data sources"
        progress-pattern: "(Read complete after|Refreshing state)"
        progress-events-estimate: 50
      phases:
        - enter-pattern: "Terraform will perform the following actions:"
          progress-pattern: "(will be created|will be read during apply|will be destroyed)"
          progress-events-estimate: 70
          label: "Generating plan"
          weight: 50
  up:
    up.terraform-apply:
      phases:
        - enter-pattern: "null_resource.wait_for_instance_ready: Creating"
          exit-pattern: "Instance is ready!"
          label: "Configuring EC2 instance"
          weight: 35
          phases:
            - enter-pattern: "Waiting for SSM agent"
              label: "Waiting for SSM agent"
              weight: 10
            - enter-pattern: "Cloudinit script is running"
              label: "Configuring EC2 instance"
              weight: 50
            - enter-pattern: "Checking instance status"
              label: "Checking instance status"
              weight: 20
            - enter-pattern: "fetching TLS certificates"
              label: "Getting TLS certificates"
              weight: 20
        - enter-pattern: "Verifying service is accessible"
          exit-pattern: "Service is accessible"
          label: "Verifying service accessibility"
          weight: 5
