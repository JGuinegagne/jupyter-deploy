services:
  e2e:
    build:
      context: .
      dockerfile: libs/jupyter-deploy-tf-aws-ec2-base/tests/e2e/image/Dockerfile
    image: jupyter-deploy-e2e-aws-ec2-base:latest
    container_name: jupyter-deploy-e2e-aws-ec2-base
    hostname: ${HOSTNAME:-localhost}
    working_dir: /workspace
    volumes:
      # Mount .auth directory to persist authentication state
      - ./.auth:/workspace/.auth
      # Mount AWS credentials (read-only)
      - ~/.aws:/root/.aws:ro
      # Mount X11 socket for GUI applications
      - /tmp/.X11-unix:/tmp/.X11-unix
      # Mount sandbox-e2e directory for E2E test deployments
      - ./sandbox-e2e:/workspace/sandbox-e2e
    environment:
      - DISPLAY=${DISPLAY}
      - AWS_PROFILE=${AWS_PROFILE:-default}
      - GITHUB_USERNAME=${GITHUB_USERNAME:-}
      - GITHUB_PASSWORD=${GITHUB_PASSWORD:-}
      # E2E deployment configuration variables
      - JD_E2E_VAR_DOMAIN=${JD_E2E_VAR_DOMAIN:-}
      - JD_E2E_VAR_SUBDOMAIN=${JD_E2E_VAR_SUBDOMAIN:-}
      - JD_E2E_VAR_EMAIL=${JD_E2E_VAR_EMAIL:-}
      - JD_E2E_VAR_OAUTH_APP_CLIENT_ID=${JD_E2E_VAR_OAUTH_APP_CLIENT_ID:-}
      - JD_E2E_VAR_OAUTH_APP_CLIENT_SECRET=${JD_E2E_VAR_OAUTH_APP_CLIENT_SECRET:-}
      - JD_E2E_VAR_OAUTH_ALLOWED_USERNAMES=${JD_E2E_VAR_OAUTH_ALLOWED_USERNAMES:-}
      - JD_E2E_VAR_OAUTH_ALLOWED_ORG=${JD_E2E_VAR_OAUTH_ALLOWED_ORG:-}
      - JD_E2E_VAR_OAUTH_ALLOWED_TEAMS=${JD_E2E_VAR_OAUTH_ALLOWED_TEAMS:-}
      # E2E test configuration variables
      - JD_E2E_USER=${JD_E2E_USER:-}
      - JD_E2E_SAFE_USER=${JD_E2E_SAFE_USER:-}
      - JD_E2E_ORG=${JD_E2E_ORG:-}
      - JD_E2E_SAFE_ORG=${JD_E2E_SAFE_ORG:-}
      - JD_E2E_TEAM=${JD_E2E_TEAM:-}
      - JD_E2E_SAFE_TEAM=${JD_E2E_SAFE_TEAM:-}
    network_mode: host
    # Keep container running in background
    command: sleep infinity
