schema_version: 1
template:
  name: "some-template-name"
  engine: "terraform"
  version: "0.1.0"
requirements:
  - name: "terraform"
  - name: "awscli"
values:
  - name: "open_url"
    source: "output"
    source-key: "url"
  - name: "aws_region"
    source: "output"
    source-key: "region"
services:
  - jupyter
  - traefik
  - oauth
commands:
  - cmd: "host.status"
    sequence:
      - api-name: "aws.ec2.describe-instance-status"
        arguments:
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
    results:
      - result-name: "host.status"
        source: "result"
        source-key: "[0].InstanceStateName"
  - cmd: "host.stop"
    sequence:
      - api-name: "aws.ec2.stop-instance"
        arguments:
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
      - api-name: "aws.ec2.wait-for-stopped"
        arguments:
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
  - cmd: "host.start"
    sequence:
      - api-name: "aws.ec2.start-instance"
        arguments:
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
      - api-name: "aws.ec2.wait-for-running"
        arguments:
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
  - cmd: "host.restart"
    sequence:
      - api-name: "aws.ec2.reboot-instance"
        arguments:
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
      - api-name: "aws.ec2.wait-for-running"
        arguments:
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
  - cmd: "host.exec"
    sequence:
      - api-name: "aws.ssm.wait-default-shell-command-sync"
        arguments:
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "commands"
            source: "cli"
            source-key: "commands"
    results:
      - result-name: "host.exec.stdout"
        source: "result"
        source-key: "[0].StandardOutputContent"
      - result-name: "host.exec.stderr"
        source: "result"
        source-key: "[0].StandardErrorContent"
      - result-name: "host.exec.returncode"
        source: "result"
        source-key: "[0].ResponseCode"
  - cmd: "server.status"
    sequence:
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
    results:
      - result-name: "server.status"
        source: "result"
        source-key: "[0].StandardOutputContent"
  - cmd: "server.start"
    sequence:
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "action"
            source: "cli"
            source-key: "action"
          - api-attribute: "service"
            source: "cli"
            source-key: "service"
  - cmd: "server.stop"
    sequence:
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "action"
            source: "cli"
            source-key: "action"
          - api-attribute: "service"
            source: "cli"
            source-key: "service"
  - cmd: "server.restart"
    sequence:
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "action"
            source: "cli"
            source-key: "action"
          - api-attribute: "service"
            source: "cli"
            source-key: "service"
  - cmd: server.logs
    sequence:
    - api-name: aws.ssm.wait-command-sync
      arguments:
      - api-attribute: document_name
        source: output
        source-key: server_logs_document
      - api-attribute: instance_id
        source: output
        source-key: instance_id
      - api-attribute: service
        source: cli
        source-key: service
      - api-attribute: extra
        source: cli
        source-key: extra
    results:
    - result-name: server.logs
      source: result
      source-key: '[0].StandardOutputContent'
    - result-name: server.errors
      source: result
      source-key: '[0].StandardErrorContent'
  - cmd: "server.exec"
    sequence:
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "server_exec_document"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "service"
            source: "cli"
            source-key: "service"
          - api-attribute: "commands"
            source: "cli"
            source-key: "commands"
    results:
      - result-name: "server.exec.stdout"
        source: "result"
        source-key: "[0].StandardOutputContent"
      - result-name: "server.exec.stderr"
        source: "result"
        source-key: "[0].StandardErrorContent"
      - result-name: "server.exec.returncode"
        source: "result"
        source-key: "[0].ResponseCode"
  - cmd: "users.add"
    sequence:
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "users"
            source: "cli"
            source-key: "users"
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "category"
            source: "cli"
            source-key: "category"
    updates:
      - variable-name: "usernames_varname"
        source: "result"
        source-key: "[1].StandardOutputContent"
  - cmd: "users.remove"
    sequence:
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "users"
            source: "cli"
            source-key: "users"
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "category"
            source: "cli"
            source-key: "category"
    updates:
      - variable-name: "usernames_varname"
        source: "result"
        source-key: "[1].StandardOutputContent"
  - cmd: "users.set"
    sequence:
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "users"
            source: "cli"
            source-key: "users"
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "category"
            source: "cli"
            source-key: "category"
    updates:
      - variable-name: "usernames_varname"
        source: "result"
        source-key: "[1].StandardOutputContent"
  - cmd: "users.list"
    sequence:
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "category"
            source: "cli"
            source-key: "category"
    results:
      - result-name: "users.list"
        source: "result"
        source-key: "[0].StandardOutputContent"
        transform: "comma-separated-str-to-list-str"
  - cmd: "teams.add"
    sequence:
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "teams"
            source: "cli"
            source-key: "teams"
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "category"
            source: "cli"
            source-key: "category"
    updates:
      - variable-name: "teamnames_varname"
        source: "result"
        source-key: "[1].StandardOutputContent"
  - cmd: "teams.remove"
    sequence:
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "teams"
            source: "cli"
            source-key: "teams"
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "category"
            source: "cli"
            source-key: "category"
    updates:
      - variable-name: "teamnames_varname"
        source: "result"
        source-key: "[1].StandardOutputContent"
  - cmd: "teams.set"
    sequence:
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "teams"
            source: "cli"
            source-key: "teams"
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "category"
            source: "cli"
            source-key: "category"
    updates:
      - variable-name: "teamnames_varname"
        source: "result"
        source-key: "[1].StandardOutputContent"
  - cmd: "teams.list"
    sequence:
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "category"
            source: "cli"
            source-key: "category"
    results:
      - result-name: "teams.list"
        source: "result"
        source-key: "[0].StandardOutputContent"
        transform: "comma-separated-str-to-list-str"
  - cmd: "organization.set"
    sequence:
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "organization"
            source: "cli"
            source-key: "organization"
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "category"
            source: "cli"
            source-key: "category"
    updates:
      - variable-name: "organization_varname"
        source: "result"
        source-key: "[1].StandardOutputContent"
  - cmd: "organization.unset"
    sequence:
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "category"
            source: "cli"
            source-key: "category"
    updates:
      - variable-name: "organization_varname"
        source: "result"
        source-key: "[0].StandardOutputContent"
  - cmd: "organization.get"
    sequence:
      - api-name: "aws.ssm.wait-command-sync"
        arguments:
          - api-attribute: "document_name"
            source: "output"
            source-key: "jd_cmd_doc_name"
          - api-attribute: "instance_id"
            source: "output"
            source-key: "instance_id"
          - api-attribute: "category"
            source: "cli"
            source-key: "category"
    results:
      - result-name: "organization.get"
        source: "result"
        source-key: "[0].StandardOutputContent"
supervised-execution:
  config:
    config.terraform-init:
      default-phase:
        label: "Configuring terraform dependencies"
        progress-pattern: "Initializing"
        progress-events-estimate: 5
    config.terraform-plan:
      default-phase:
        label: "Generating plan"
        progress-pattern: "(Read complete after|Refreshing state)"
        progress-events-estimate: 15
  up:
    up.terraform-apply:
      default-phase:
        label: "Mutating resources"
        progress-pattern: "(Creation complete after|Modifications complete after|Destruction complete after)"
        progress-events-estimate-dynamic-source: "plan.to_update"     
      phases:
        - enter-pattern: "null_resource.wait_for_instance_ready: Creating"
          exit-pattern: "null_resource.wait_for_instance_ready: Creation complete"
          label: "Configuring EC2 instance"
          weight: 40
          phases:
            - enter-pattern: "Waiting for SSM agent"
              label: "Waiting for SSM agent"
              weight: 10
            - enter-pattern: "Cloudinit script is running"
              label: "Configuring EC2 instance"
              weight: 50
            - enter-pattern: "Checking instance status"
              label: "Checking instance status"
              weight: 20
            - enter-pattern: "fetching TLS certificates"
              label: "Getting TLS certificates"
              weight: 20
  down:
    down.terraform-destroy:
      default-phase:
        label: "Evaluating resources to destroy"
        progress-pattern: "(Read complete after|Refreshing state\\.\\.\\.\\[id=)"
        progress-events-estimate: 50
      phases:
        - enter-pattern: "Plan: \\d+ to add, \\d+ to change, (\\d+) to destroy\\."
          progress-events-estimate-capture-group: 1
          progress-pattern: "Destruction complete after"
          label: "Destroying resources"
          weight: 100
